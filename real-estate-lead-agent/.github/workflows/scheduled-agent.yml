name: Scheduled Lead Agent Execution

on:
  schedule:
    # Executa todos os dias às 08:00 UTC (05:00 BRT)
    - cron: '0 8 * * *'
    # Executa novamente às 14:00 UTC (11:00 BRT)
    - cron: '0 14 * * 1-5'
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: real-estate-lead-agent

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: real-estate-lead-agent/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Chromium
        run: npx puppeteer browsers install chrome

      - name: Build TypeScript
        run: npm run build

      - name: Run Lead Agent
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
          AGENT_MAX_RESULTS_PER_QUERY: '20'
          AGENT_MAX_PAGES_TO_ANALYZE: '50'
          LOG_LEVEL: 'info'
        run: node dist/index.js --mode=run

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.run_number }}
          path: real-estate-lead-agent/logs/
          retention-days: 30
